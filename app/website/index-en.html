<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="">
<meta name="author" content="">
<title>PallyCon Viblast Player</title>
<!-- Bootstrap core CSS -->
<link href="./css/bootstrap.css" rel="stylesheet">
<!-- Add custom CSS here -->
<link href="./css/stylish-portfolio.css" rel="stylesheet">
<link href="./font-awesome/css/font-awesome.min.css" rel="stylesheet">
<!-- Bootstrap core JavaScript -->
<!-- Placed at the end of the document so the pages load faster -->
<script src="./js/jquery-3.1.0.min.js"></script>
<script src="./js/bootstrap.js"></script>
<style type="text/css">
html
{
	min-width: 700px;
}
body
{
	font-family: 'Malgun Gothic';
}
.playerobject
{
	width: 0px;
	height: 0px;
}

.player_container{
	width: 720px; /* 정렬하려는 요소의 넓이를 반드시 지정 */
	margin: 0 auto;
	text-align: center;
}
#player{
	width: 720px;
}
</style>
<script src="./js/viblast.js"></script>
<script type="text/javascript" charset="utf-8">
var playspeed = 1.0;
var is_chrome_or_firefox = false;

var agent = navigator.userAgent.toLowerCase();

if (agent.indexOf("chrome") != -1 || agent.indexOf("firefox") != -1){
	if(agent.indexOf("edge/") != -1){
		is_chrome_or_firefox = false;
	}else{
		is_chrome_or_firefox = true;
	}
}

function play(){
	var videoCheck = 0;
	viblast('#player').setup({
		key: 'N8FjNTQ3NDdhZqZhNGI5NWU5ZTI=',
		//stream: 'https://d28giv01x4pn7o.cloudfront.net/gosigak01/stream.mpd',
		//stream: 'https://s3.ap-northeast-2.amazonaws.com/mpdsample/gosigak01/stream.mpd',
		stream: './contents/bbb/stream.mpd',
		widevine: {
			'licensing-server': 'https://tokyo.pallycon.com/ri/licenseManager.do'
		},
		xhrBeforeSend: function(ev) {
			// filter out non-drm requests
			// ev.url.indexOf("//tokyo.pallycon.com/ri/licenseManager.do") < 0 is another possible check
			if (ev.method !== "POST") return;

			if (is_chrome_or_firefox) {
				ev.xhr.setRequestHeader('pallycon-customdata', 'W8KAJ'+ $("#aesData1").val());
			}
			else {
				//alert("not chrome/firefox! is it IE/Edge?");
				ev.xhr.setRequestHeader('pallycon-customdata', 'P8KAJ'+ $("#aesData1").val());
			}
			//console.log('Sending a ', ev.method, 'request to ', ev.url, 'by Viblast instance', ev.target);
			ev.xhr.addEventListener('load', function() {
				if( 1 > videoCheck){
					var responseText = String.fromCharCode.apply(null, new Uint8Array(ev.xhr.response)); // assumes utf8
					if (responseText.indexOf('errorCode') > 0) {
						// this alert should be properly parsed and displayed for commercial use
						var errorCode = JSON.parse(responseText).errorCode;
						if("8002" != errorCode){
							alert("PallyCon Error : " + JSON.parse(responseText).message + "(" + JSON.parse(responseText).errorCode+ ")");
							//window.alert('No Rights. Server Response ' + responseText);
						}else{
							var message = JSON.parse(responseText).message;
							alert("Error : " + JSON.parse(message).MESSAGE + "(" + JSON.parse(message).ERROR + ")");
						}
					}
					videoCheck += 1;
				}
			});
		},
		autoplay: true
	});
	document.getElementById('player').viblast.abr;
}

function makeCustomDrm() {
	var userId = makeid();
	var param = "user-id=" + userId + "&cid=8KAJcid1234562";
	console.log(param);
	$.ajax({
		type: "POST",
		url: "makeDrmData.jsp",
		data: param,
		async: false,
		dataType:"json",
		success : function (response){
			$("#aesData1").val(response["cont1"]);
//			$("#aesData2").val(response["cont2"]);
			play();
		},
		error: function( jqXHR, textStatus, errorThrown )
        {
            alert( textStatus + ", " + errorThrown );
        }
	});
}

function makeid()
{
    var text = "";
    var possible = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";

    for( var i=0; i < 7; i++ )
        text += possible.charAt(Math.floor(Math.random() * possible.length));

    return text;
}

function resetPlaySpeed() {
	if (parseFloat(playspeed).toFixed(1) == 1.0)
		return;

	playspeed = 1.0;
	document.getElementById("text_speed").value = parseFloat(playspeed).toFixed(1)+"X";
	document.getElementById('player').playbackRate = playspeed;
}

function playSlower() {
	if (parseFloat(playspeed).toFixed(1) > 0.5) {
		playspeed -= 0.1;
		document.getElementById("text_speed").value = parseFloat(playspeed).toFixed(1)+"X";
		document.getElementById('player').playbackRate = playspeed;
	}
}

function playFaster() {
	if (parseFloat(playspeed).toFixed(1) < 2.0) {
		playspeed += 0.1;
		document.getElementById("text_speed").value = parseFloat(playspeed).toFixed(1)+"X";
		document.getElementById('player').playbackRate = playspeed;
	}
}

$(document).ready(function(){
	makeCustomDrm();
});
	</script>
</head>
<body>
<input type="hidden" id="aesData1">
    <div id="top" class="services">
        <div class="container">
            <div class="row">
                <div class="col-md-12 text-center">
                    <h1>
                       PallyCon Viblast DASH Player Demo</h1>
                    <br /><br />
                </div>
            </div>
            <div class="row">
                <div class="player_container">
					<video id="player" controls width="1080"></video>
					<input type="text" id="text_speed" value="1.0X">
					<a id="speed-increase-button" class="btn btn-large btn-primary" href='javascript:playFaster()'>Faster</a>
					<a id="speed-decrease-button" class="btn btn-large btn-primary" href='javascript:playSlower()'>Slower</a>
					<a id="speed-reset-button" class="btn btn-large btn-primary" href='javascript:resetPlaySpeed()'>Reset Speed</a>
                </div>
            </div>
        </div>
    </div>
    <!-- Intro -->
    <div id="intro" class="intro">
        <div class="container">
            <div class="row">
                <div class="col-md-12 col-md-offset-12 text-center">
                    <h2 style="line-height:45px">
                        "PallyCon Viblast DASH Player" is a PC web player <br> which supports HTML5 and DASH-CENC standard.</h2>
                    <br />
                    <!--<p class="lead">
                        KT olleh tv now, olleh tv school, 대한민국 국회 등 국내 대형 교육 서비스 및 IPTV 서비스에 적용하여 안정된 서비스를
                        제공하고 있습니다.</p>-->
                </div>
            </div>
        </div>
    </div>
    <!-- /Intro -->
    <!-- Features -->
    <div id="features" class="services">
        <div class="container">
            <div class="row">
                <div class="col-md-4 col-md-offset-4 text-center">
                    <h2>
                        Features</h2>
                    <hr>
                </div>
            </div>
            <div class="row">
                <div class="col-md-2 col-md-offset-2 text-center">
                    <div class="service-item">
                        <i class="service-icon icon-play-circle"></i>
                        <h4>HTML5 Standard</h4>
                        <p>Video streaming without plugin installation</p>
                    </div>
                </div>
                <div class="col-md-2 text-center">
                    <div class="service-item">
                        <i class="service-icon icon-shield"></i>
                        <h4>Common Encryption</h4>
                        <p>Studio-approved platform level DRM support</p>
                    </div>
                </div>
                <div class="col-md-2 text-center">
                    <div class="service-item">
                        <i class="service-icon icon-cloud"></i>
                        <h4>PallyCon Cloud</h4>
                        <p>Cloud-based pay-as-you-go DRM licensing service</p>
                    </div>
                </div>
                <div class="col-md-2 text-center">
                    <div class="service-item">
                        <i class="service-icon icon-ok"></i>
                        <h4>Quick and Easy</h4>
                        <p>Pre-integrated with PallyCon multi-DRM</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- /Callout -->
    <!-- Call to Action -->
    <div id="contact" class="call-to-action">
        <div class="container">
            <div class="row">
                <div class="col-md-6 col-md-offset-3 text-center">
                    <h2>
                        Contact Info</h2>
                    <br />
                    <p>
                        <i class="icon-envelope icon"></i> <a href="mailto:obiz@pallycon.com">obiz@pallycon.com</a> <br>
                        <i class="icon-home icon"></i> <a href="https://www.pallycon.com">www.PallyCon.com</a><br>
                    </p>
                </div>
            </div>
        </div>
    </div>
    <!-- /Call to Action -->
    <!-- Footer -->
    <footer>
      <div class="container">
        <div class="row">
          <div class="col-md-6 col-md-offset-3 text-center">
            <!--
            <ul class="list-inline">
              <li><i class="icon-facebook icon-2x"></i></li>
              <li><i class="icon-twitter icon-2x"></i></li>
              <li><i class="icon-dribbble icon-2x"></i></li>
            </ul>
            <hr>
            -->
            <p>Copyright &copy; INKAENTWORKS Co.,Ltd.</p>
          </div>
        </div>
      </div>
    </footer>
    <!-- /Footer -->
    <!-- Custom JavaScript for the Side Menu - Put in a custom JS file if you want to clean this up -->

</body>
</html>
